<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuardle - 4 Palabras</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
        }
        h1 { margin: 10px 0 5px; font-size: 1.5rem; }
        
        .game-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 5px;
            width: 100%;
            box-sizing: border-box;
            padding-bottom: calc(20vh + env(safe-area-inset-bottom));
        }

        .board {
            background: white;
            padding: 4px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            --board-width: calc((100vw - 10px) / 2);
            --tile-size: calc((var(--board-width) - 18px) / 5);
            height: calc(var(--tile-size) * 5 + 10px);
            min-height: 150px;
        }

        .board-track {
            display: grid;
            grid-template-rows: repeat(9, var(--tile-size));
            gap: 2px;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; }

        .tile {
            aspect-ratio: 1 / 1; 
            background: white;
            border: 1.5px solid #d3d6da;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            text-transform: uppercase;
            box-sizing: border-box;
            font-size: clamp(12px, calc(var(--tile-size) * 0.32), 20px);
            width: var(--tile-size);
            height: var(--tile-size);
        }

        .correct { background-color: #6aaa64; color: white; border-color: #6aaa64; }
        .present { background-color: #c9b458; color: white; border-color: #c9b458; }
        .absent  { background-color: #787c7e; color: white; border-color: #787c7e; }
        .solved-overlay { opacity: 0.5; }

        #message { font-weight: bold; font-size: 1rem; min-height: 25px; margin: 5px 0; text-align: center; }

        #share-btn {
            display: none; 
            background-color: #6aaa64;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .keyboard {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #e2e4e6;
            padding: 8px 0;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        .kb-row { display: flex; gap: 3px; justify-content: center; width: 100%; max-width: 600px; padding: 0 8px; }
        .key {
            min-width: 0;
            font-weight: bold; border: none; padding: 0; cursor: pointer;
            background-color: #d1d2d4; border-radius: 6px; height: clamp(45px, 8vh, 60px);
            flex: 1; display: flex; justify-content: center; align-items: center;
            font-size: clamp(0.8rem, 3vw, 1.1rem);
            user-select: none; touch-action: manipulation;
        }
        .key-wide { flex: 1.5; }
        .key-delete, .key-confirm { background-color: #000 !important; color: #fff !important; }
        .key.disabled { opacity: 0.4; pointer-events: none; }
        .key-exhausted .key-label { opacity: 0.4; }

        .key-multi { position: relative; overflow: hidden; }
        .key-grid { position: absolute; inset: 2px; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 1px; }
        .quad { background-color: #cfd2d6; border-radius: 1px; }
        .quad.correct { background-color: #6aaa64; }
        .quad.present { background-color: #c9b458; }
        .quad.absent  { background-color: #aeb5bc; }
        .key-label { position: relative; z-index: 2; }
    </style>
</head>
<body>

    <h1>Cuardle</h1>
    <div id="message">Cargando palabras...</div>
    <button id="share-btn">ðŸ“‹ Compartir Resultado</button>

    <div class="game-container" id="game-container"></div>
    <div class="keyboard" id="keyboard"></div>

    <script>
        // CONFIGURACIÃ“N INICIAL
        const START_DATE = new Date('2026-02-05');
        const maxGuesses = 9;
        const wordLength = 5;

        // ESTADO GLOBAL
        let targetWords = [];
        let wordPools = {};
        let currentGuess = "";
        let currentRow = 0;
        let boardSolved = [false, false, false, false];
        let boardSolvedAt = [null, null, null, null];
        let gameOver = false;
        let keyboardState = {};
        let disabledLetters = new Set();
        let guesses = [];

        // 1. CARGA DE DATOS EXTERNOS
        async function initGame() {
            try {
                const response = await fetch('palabras.json');
                if (!response.ok) throw new Error("No se pudo cargar el archivo de palabras");
                wordPools = await response.json();
                
                targetWords = getDailyWords();
                setupBoard();
                setupKeyboard();
                loadGameState();
                document.getElementById('message').textContent = "";
            } catch (err) {
                document.getElementById('message').textContent = "Error al iniciar el juego.";
                console.error(err);
            }
        }

        function getDailyWords() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const dayOfMonth = today.getDate();
            
            const pool = wordPools[currentMonth] || wordPools["default"];
            const shuffled = [...pool];
            
            // Barajado determinista por mes
            let seed = 12345 + currentMonth;
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor((Math.sin(seed++) * 10000 - Math.floor(Math.sin(seed) * 10000)) * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            const startIndex = ((dayOfMonth - 1) * 4) % shuffled.length;
            return [
                shuffled[startIndex % shuffled.length],
                shuffled[(startIndex + 1) % shuffled.length],
                shuffled[(startIndex + 2) % shuffled.length],
                shuffled[(startIndex + 3) % shuffled.length]
            ].map(w => w.toUpperCase());
        }

        // 2. CONSTRUCCIÃ“N DE LA INTERFAZ
        function setupBoard() {
            const container = document.getElementById('game-container');
            container.innerHTML = "";
            for (let b = 0; b < 4; b++) {
                let boardDiv = document.createElement('div');
                boardDiv.className = 'board';
                boardDiv.id = `board-${b}`;
                let track = document.createElement('div');
                track.className = 'board-track';
                track.id = `board-${b}-track`;

                for (let r = 0; r < maxGuesses; r++) {
                    let row = document.createElement('div');
                    row.className = 'row';
                    for (let t = 0; t < wordLength; t++) {
                        let tile = document.createElement('div');
                        tile.className = 'tile';
                        tile.id = `board-${b}-row-${r}-tile-${t}`;
                        row.appendChild(tile);
                    }
                    track.appendChild(row);
                }
                boardDiv.appendChild(track);
                container.appendChild(boardDiv);
            }
        }

        function setupKeyboard() {
            const kbContainer = document.getElementById('keyboard');
            kbContainer.innerHTML = "";
            const layout = ["QWERTYUIOP", "ASDFGHJKLÃ‘", "ZXCVBNM"];
            layout.forEach((rowStr, i) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'kb-row';
                if (i === 2) createKey(rowDiv, 'âŒ«', 'key-wide key-delete', 'BACKSPACE');
                for (let char of rowStr) createKey(rowDiv, char, '');
                if (i === 2) createKey(rowDiv, 'ENTER', 'key-wide key-confirm');
                kbContainer.appendChild(rowDiv);
            });
        }

        function createKey(container, display, className, actionId) {
            const btn = document.createElement('button');
            btn.className = `key key-multi ${className}`;
            btn.id = `key-${actionId || display}`;
            if (/^[A-ZÃ‘]$/.test(display)) {
                btn.innerHTML = `<div class="key-grid">${[0,1,2,3].map(n => `<div class="quad" data-board="${n}"></div>`).join('')}</div><span class="key-label">${display}</span>`;
            } else {
                btn.textContent = display;
            }
            btn.onclick = () => handleInput(actionId || display);
            container.appendChild(btn);
        }

        // 3. LÃ“GICA DEL JUEGO
        function handleInput(key) {
            if (gameOver) return;
            if (key === 'ENTER') submitGuess();
            else if (key === 'BACKSPACE' || key === 'âŒ«') {
                currentGuess = currentGuess.slice(0, -1);
                updateGridDisplay();
            } else if (/^[A-ZÃ‘]$/.test(key) && currentGuess.length < wordLength) {
                currentGuess += key;
                updateGridDisplay();
            }
        }

        function updateGridDisplay() {
            for (let b = 0; b < 4; b++) {
                if (boardSolved[b]) continue;
                for (let i = 0; i < wordLength; i++) {
                    document.getElementById(`board-${b}-row-${currentRow}-tile-${i}`).textContent = currentGuess[i] || "";
                }
            }
        }

        function submitGuess() {
            if (currentGuess.length !== wordLength) return;

            const guess = currentGuess;
            for (let b = 0; b < 4; b++) {
                if (boardSolved[b]) continue;
                
                const target = targetWords[b];
                let colors = Array(5).fill('absent');
                let tArr = target.split('');
                let gArr = guess.split('');

                gArr.forEach((char, i) => {
                    if (char === tArr[i]) { colors[i] = 'correct'; tArr[i] = null; gArr[i] = null; }
                });
                gArr.forEach((char, i) => {
                    if (char && tArr.includes(char)) { colors[i] = 'present'; tArr[tArr.indexOf(char)] = null; }
                });

                colors.forEach((c, i) => {
                    const tile = document.getElementById(`board-${b}-row-${currentRow}-tile-${i}`);
                    tile.classList.add(c);
                    updateKeyboardState(guess[i], b, c);
                });

                if (guess === target) {
                    boardSolved[b] = true;
                    boardSolvedAt[b] = currentRow + 1;
                    document.getElementById(`board-${b}`).classList.add('solved-overlay');
                }
            }

            guesses.push(guess);
            saveGameState();
            currentRow++;
            currentGuess = "";
            updateKeyboardVisuals();
            scrollToActiveRow();
            checkEndGame();
        }

        function updateKeyboardState(letter, boardIdx, color) {
            if (!keyboardState[letter]) keyboardState[letter] = [null, null, null, null];
            const weights = { correct: 3, present: 2, absent: 1, null: 0 };
            if (weights[color] > weights[keyboardState[letter][boardIdx]]) {
                keyboardState[letter][boardIdx] = color;
            }
        }

        function updateKeyboardVisuals() {
            for (const letter in keyboardState) {
                const keyBtn = document.getElementById(`key-${letter}`);
                if (!keyBtn) continue;
                const quads = keyBtn.querySelectorAll('.quad');
                let isExhausted = true;
                keyboardState[letter].forEach((state, i) => {
                    quads[i].className = 'quad' + (state ? ` ${state}` : '');
                    if (!boardSolved[i] && state !== 'absent') isExhausted = false;
                });
                if (isExhausted) keyBtn.classList.add('key-exhausted');
            }
        }

        function scrollToActiveRow() {
            const tile = document.querySelector('.tile');
            const rowH = tile.offsetHeight + 2;
            for (let b = 0; b < 4; b++) {
                const track = document.getElementById(`board-${b}-track`);
                if (boardSolved[b]) { track.style.transform = 'translateY(0)'; continue; }
                let offset = currentRow > 3 ? (currentRow - 4) * rowH : 0;
                track.style.transform = `translateY(-${offset}px)`;
            }
        }

        function checkEndGame() {
            if (boardSolved.every(s => s)) {
                gameOver = true;
                document.getElementById('message').textContent = "Â¡VICTORIA! ðŸŽ‰";
                showShare();
            } else if (currentRow >= maxGuesses) {
                gameOver = true;
                document.getElementById('message').textContent = `Fin: ${targetWords.join(" ")}`;
                showShare();
            }
        }

        // 4. PERSISTENCIA Y COMPARTIR
        function saveGameState() {
            const data = { date: new Date().toDateString(), guesses };
            localStorage.setItem('cuardle_state', JSON.stringify(data));
        }

        function loadGameState() {
            const saved = localStorage.getItem('cuardle_state');
            if (!saved) return;
            const parsed = JSON.parse(saved);
            if (parsed.date === new Date().toDateString()) {
                parsed.guesses.forEach(g => { currentGuess = g; submitGuess(); });
            }
        }

        function showShare() {
            document.getElementById('share-btn').style.display = 'block';
        }

        document.getElementById('share-btn').onclick = () => {
            let text = `Cuardle #${Math.floor((new Date() - START_DATE)/(1000*3600*24))} ðŸ§©\n`;
            text += boardSolvedAt.map(s => s || 'ðŸ’€').join(' ') + '\n\n';
            // LÃ³gica simplificada de compartir aquÃ­...
            navigator.clipboard.writeText(text);
            alert("Resultado copiado!");
        };

        // Iniciar
        initGame();

        // Listener teclado fÃ­sico
        document.addEventListener('keydown', (e) => {
            let k = e.key.toUpperCase();
            if (k === 'ENTER' || k === 'BACKSPACE') handleInput(k);
            else if (/^[A-ZÃ‘]$/.test(k)) handleInput(k);
        });
    </script>
</body>
</html>
